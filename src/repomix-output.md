This file is a merged representation of the entire codebase, combining all repository files into a single document.
Generated by Repomix on: 2025-08-30 12:23:14

# File Summary

## Purpose:

This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

## File Format:

The content is organized as follows:
1. This summary section
2. Repository information
3. Repository structure
4. Multiple file entries, each consisting of:
   a. A header with the file path (## File: path/to/file)
   b. The full contents of the file in a code block

## Usage Guidelines:

- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

## Notes:

- Some files may have been excluded based on .gitignore rules and Repomix's
  configuration.
- Binary files are not included in this packed representation. Please refer to
  the Repository Structure section for a complete list of file paths, including
  binary files.

## Additional Information:

For more information about Repomix, visit: https://github.com/andersonby/python-repomix


# Repository Structure

```
index.html
js
  api_byo.js
  app.js
  config.js
  diff.js
  ui.js
  util.js
repomix-output.md
styles.css
```

# Repository Files


## index.html

```html
<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>legacy.exe</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <header>
    <h1>legacy.exe</h1>
    <div class="sub">byo-key client</div>
  </header>

  <main>
    <section class="panel">
      <div class="grid4">
        <div class="row">
          <label>linguagem</label>
          <select id="language">
            <option value="java">java</option>
            <option value="python">python</option>
            <option value="javascript">javascript</option>
            <option value="csharp">csharp</option>
          </select>
        </div>
        <div class="row">
          <label>provider</label>
          <select id="provider">
            <option value="gemini">gemini</option>
            <option value="openai">openai</option>
          </select>
        </div>
        <div class="row">
          <label>model</label>
          <input id="model" placeholder="auto">
        </div>
        <div class="row">
          <label>api key</label>
          <input id="apikey" type="password" placeholder="cole sua chave">
          <button id="remember" class="toggle">remember key</button>
        </div>
      </div>

      <div class="row code-wrap collapsed">
        <label>código legado</label>
        <textarea id="legacy" placeholder="cole aqui" rows="20"></textarea>
        <button id="btn-expand" class="ghost" aria-expanded="false">mostrar mais</button>
      </div>

      <div class="actions below">
        <button id="btn-refactor">refatorar</button>
        <button id="btn-sample">sample</button>
        <div class="muted" id="status"></div>
      </div>
    </section>

    <section class="panel output">
      <div class="columns">
        <div>
          <h3>antes</h3>
          <pre id="before"><code></code></pre>
        </div>
        <div>
          <h3>depois</h3>
          <pre id="after"><code></code></pre>
        </div>
      </div>

      <div class="columns meta">
        <div>
          <h3>diff</h3>
          <pre id="diff"><code></code></pre>
        </div>
        <div>
          <h3>notas</h3>
          <ul id="notes"></ul>
          <h3>summary</h3>
          <ul id="summary"></ul>
          <div class="save">
            <button id="btn-download">baixar código</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="overlay">
    <div class="loader"></div>
    <div class="msg">refatorando...</div>
  </div>

  <script type="module" src="./js/app.js"></script>
</body>
</html>
```

## js/api_byo.js

````javascript
function sysRefactor(lang){
  return `Você é um agente de modernização de código.
Responda **APENAS** JSON válido no formato:
{"code": "<string com o código completo>", "summary": "<lista ou string>", "notes": "<lista ou string>"}.
Sem comentários fora do JSON. Linguagem alvo: ${lang}.`
}
function sysReview(lang){
  return `Você é um revisor. Dado {original, refactored}, devolva **APENAS**:
{"code":"<string com o código final>", "notes":"<lista ou string>"}.
Sem texto fora do JSON. Linguagem: ${lang}.`
}

// ---- robustez de parsing/normalização ----
function asArray(x){
  if (Array.isArray(x)) return x;
  if (x == null) return [];
  return String(x).split(/\r?\n|[;•]+/).map(s=>s.trim()).filter(Boolean);
}
function normalize(obj){
  // obj pode ser {}, string, number, etc.
  if (obj == null) return { code:"", summary:"", notes:"" };
  if (typeof obj === "string" || typeof obj === "number" || typeof obj === "boolean"){
    return { code: String(obj), summary:"", notes:"" };
  }
  const code = obj.code != null ? String(obj.code) : "";
  const summary = obj.summary != null ? asArray(obj.summary) : [];
  const notes = obj.notes != null ? asArray(obj.notes) : [];
  return { code, summary, notes };
}
function safeJSON(s){
  try{
    const j = JSON.parse(s);
    return normalize(j);
  }catch{}
  const m = String(s).match(/```(?:json)?\s*([\s\S]*?)```/i);
  if (m){
    try{ return normalize(JSON.parse(m[1])) }catch{}
  }
  // fallback: joga tudo em notes pra debug, sem quebrar UI
  return { code:"", summary:[], notes:String(s||"") };
}

async function callOpenAI({apiKey,model,messages}){
  const r = await fetch("https://api.openai.com/v1/chat/completions",{
    method:"POST",
    headers:{authorization:`Bearer ${apiKey}`,"content-type":"application/json"},
    body:JSON.stringify({model:model||"gpt-4o-mini",temperature:0.2,messages})
  });
  const t = await r.text();
  if(!r.ok) throw new Error(t);
  const j = JSON.parse(t);
  return j.choices?.[0]?.message?.content ?? "";
}

function toGemini(messages){
  // gemini aceita "contents"; manter ordem e instruções
  return messages.map(m=>({role:m.role==="system"?"user":m.role,parts:[{text:String(m.content)}]}));
}
async function callGemini({apiKey,model,messages}){
  const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model||"gemini-1.5-flash"}:generateContent?key=${apiKey}`,{
    method:"POST",
    headers:{"content-type":"application/json"},
    body:JSON.stringify({contents:toGemini(messages),generationConfig:{temperature:0.2}})
  });
  const t = await r.text();
  if(!r.ok) throw new Error(t);
  const j = JSON.parse(t);
  return j.candidates?.[0]?.content?.parts?.map(p=>p.text||"").join("") ?? "";
}

export async function refactorBYO({provider,model,apiKey,code,language}){
  const m1=[
    {role:"system",content:sysRefactor(language)},
    {role:"user",content:`original:\n\`\`\`${language}\n${code}\n\`\`\``}
  ];
  const raw1 = provider==="openai"
    ? await callOpenAI({apiKey,model,messages:m1})
    : await callGemini({apiKey,model,messages:m1});
  const j1 = safeJSON(raw1);               // {code, summary, notes}

  const m2=[
    {role:"system",content:sysReview(language)},
    {role:"user",content:JSON.stringify({original:code,refactored:j1.code||""})}
  ];
  const raw2 = provider==="openai"
    ? await callOpenAI({apiKey,model,messages:m2})
    : await callGemini({apiKey,model,messages:m2});
  const j2 = safeJSON(raw2);               // {code, notes}

  // escolha final, garantindo string
  const finalCode = (j2.code && String(j2.code).trim()) || (j1.code && String(j1.code).trim()) || "";
  return {
    code: finalCode,
    summary: j1.summary,
    notes: j2.notes.length ? j2.notes : j1.notes
  };
}
````

## js/app.js

```javascript
import { refactorBYO } from "./api_byo.js"
import { saveConfig, loadConfig } from "./config.js"
import { el } from "./util.js"
import {
  bindSample, bindRefactor, bindRemember, readInputs, setInputs,
  showBefore, showAfter, showMeta, bindDownload, overlay,
  mountState, showError, status, bindExpand
} from "./ui.js"

const state = mountState()
function setLegacy(v){ el("#legacy").value = v }

const cfg = loadConfig()
setInputs(cfg||{})

bindSample(setLegacy)
bindRemember()
bindExpand()

bindRefactor(async ()=>{
  const input = readInputs()
  if(!input.code.trim()) return
  if(!input.apiKey) { showError("api key ausente"); return }
  if(input.save) saveConfig({provider:input.provider,model:input.model,apiKey:input.apiKey,save:true})

  showBefore(input.code)
  overlay(true); status("rodando...")
  const t0 = performance.now()

  try{
    const r = await refactorBYO({
      provider: input.provider,
      model: input.model,
      apiKey: input.apiKey,
      code: input.code,
      language: input.language
    })
    if(!(r.code && r.code.trim())){
      showError(r.notes || "falha na refatoração")
    }else{
      showAfter(r.code||"")
      state.setAfter(r.code||"")
      showMeta({ before: input.code, after: r.code||"", notes: r.notes||[], summary: r.summary||[] })
    }
  }catch(e){
    showError(String(e))
  }finally{
    const ms = Math.round(performance.now()-t0)
    overlay(false); status(`${input.provider} · ${input.model||"auto"} · ${ms}ms`)
  }
})

bindDownload(()=>state.getAfter())
```

## js/config.js

```javascript
const K="legacyexe.v1"
export function saveConfig({provider,model,apiKey,save}){
  try{ localStorage.setItem(K, JSON.stringify({provider,model,apiKey,save:!!save})) }catch{}
}
export function loadConfig(){
  try{ return JSON.parse(localStorage.getItem(K)||"{}") }catch{ return {} }
}
export function hasSaved(){ try{ return !!(JSON.parse(localStorage.getItem(K)||"{}").apiKey) }catch{ return false } }
```

## js/diff.js

```javascript
function lcsLines(A,B){
  const m=A.length,n=B.length,dp=Array.from({length:m+1},()=>Array(n+1).fill(0))
  for(let i=1;i<=m;i++)for(let j=1;j<=n;j++)
    dp[i][j]=A[i-1]===B[j-1]?dp[i-1][j-1]+1:Math.max(dp[i-1][j],dp[i][j-1])
  const out=[];let i=m,j=n
  while(i>0&&j>0){
    if(A[i-1]===B[j-1]){out.push({t:" ",v:A[i-1]});i--;j--}
    else if(dp[i-1][j]>=dp[i][j-1]){out.push({t:"-",v:A[i-1]});i--}
    else{out.push({t:"+",v:B[j-1]});j--}
  }
  while(i>0){out.push({t:"-",v:A[i-1]});i--}
  while(j>0){out.push({t:"+",v:B[j-1]});j--}
  return out.reverse()
}
export function unifiedDiff(a,b){
  const A=String(a||"").split("\n"),B=String(b||"").split("\n")
  const seq=lcsLines(A,B)
  const lines = ["--- antes","+++ depois",...seq.map(x=>`${x.t} ${x.v}`)]
  return lines.join("\n")
}
```

## js/ui.js

```javascript
import { el, setText, bulletsToList, download } from "./util.js"
import { unifiedDiff } from "./diff.js"

// ---- remember key ----
let remember = false
export function bindRemember(){
  const btn = el("#remember")
  btn.addEventListener("click",()=>{
    remember = !remember
    btn.classList.toggle("active", remember)
    btn.textContent = remember ? "remember key ✓" : "remember key"
  })
}
export function shouldRemember(){ return remember }
export function setRemember(v){
  remember = !!v
  const btn = el("#remember")
  btn.classList.toggle("active", remember)
  btn.textContent = remember ? "remember key ✓" : "remember key"
}

// ---- expand/collapse editor: clamp ~20 linhas e auto-grow sem scrollbar ----
function setClampHeight(container, lines=20){
  const ta = container.querySelector("textarea")
  const cs = getComputedStyle(ta)
  const lh = parseFloat(cs.lineHeight || "18")
  const py = parseFloat(cs.paddingTop||"12")+parseFloat(cs.paddingBottom||"12")
  const max = Math.round(lh*lines + py)
  container.style.setProperty("--ta-max", `${max}px`)
}
function autosize(ta){
  ta.style.height = "auto"
  ta.style.height = ta.scrollHeight + "px"
}
export function bindExpand(){
  const wrap = el(".code-wrap")
  const ta   = el("#legacy")
  const btn  = el("#btn-expand")

  const sync = () => {
    const collapsed = wrap.classList.contains("collapsed")
    btn.textContent = collapsed ? "mostrar mais" : "mostrar menos"
    btn.setAttribute("aria-expanded", String(!collapsed))
    if (collapsed){
      // volta a usar o clamp controlado por CSS
      setClampHeight(wrap, 20)
      ta.style.height = ""
    } else {
      // cresce até caber todo conteúdo
      autosize(ta)
    }
  }

  btn.addEventListener("click", ()=>{
    wrap.classList.toggle("collapsed")
    sync()
  })

  // enquanto digita, só autosize quando expandido
  ta.addEventListener("input", ()=>{ if(!wrap.classList.contains("collapsed")) autosize(ta) })

  window.addEventListener("resize", sync)

  // init
  wrap.classList.add("collapsed")
  setClampHeight(wrap, 20)
  sync()
}

// ---- misc UI helpers ----
export function bindSample(setLegacy){
  el("#btn-sample").addEventListener("click",()=>{ 
    setLegacy(`public class Exemplo {
  public static void main(String[] args){
    System.out.println("Olá mundo");
  }
}`) })
}
export function bindRefactor(onRun){ el("#btn-refactor").addEventListener("click", onRun) }
export function readInputs(){
  return {
    language: el("#language").value,
    provider: el("#provider").value,
    model: el("#model").value.trim() || undefined,
    apiKey: el("#apikey").value.trim(),
    code: el("#legacy").value,
    save: shouldRemember()
  }
}
export function setInputs({provider,model,apiKey,save}){
  if(provider) el("#provider").value = provider
  if(model) el("#model").value = model
  if(apiKey) el("#apikey").value = apiKey
  setRemember(!!save || !!apiKey)
}
export function showBefore(code){ setText(el("#before code"), code||"") }
export function showAfter(code){ setText(el("#after code"), code||"") }
export function showMeta({before, after, notes, summary}){
  setText(el("#diff code"), unifiedDiff(before, after))
  bulletsToList(el("#notes"), notes)
  bulletsToList(el("#summary"), summary)
}
export function showError(msg){
  setText(el("#after code"), "")
  bulletsToList(el("#notes"), [`erro: ${msg}`])
}
export function bindDownload(getAfter){
  el("#btn-download").addEventListener("click",()=>{
    const out = getAfter()
    if(!out) return
    download("legacy_refatorado.txt", out)
  })
}
export function overlay(v){ el("#overlay").style.display = v ? "flex" : "none" }
export function status(t){ el("#status").textContent = t||"" }
export function mountState(){ let after=""; return { setAfter:v=>after=v, getAfter:()=>after } }
```

## js/util.js

```javascript
export function el(q){return document.querySelector(q)}
export function setText(node, text){node.textContent = text}
export function download(filename, text){
  const a = document.createElement("a")
  a.href = URL.createObjectURL(new Blob([text],{type:"text/plain"}))
  a.download = filename
  a.click()
  URL.revokeObjectURL(a.href)
}
export function bulletsToList(node, s){
  node.innerHTML = ""
  if(!s) return
  const arr = Array.isArray(s) ? s : String(s).split(/[\r\n;•-]+/).map(x=>x.trim()).filter(Boolean)
  for(const p of arr.slice(0,12)){
    const li = document.createElement("li")
    li.textContent = p
    node.appendChild(li)
  }
}
```

## repomix-output.md

`````markdown
This file is a merged representation of the entire codebase, combining all repository files into a single document.
Generated by Repomix on: 2025-08-30 12:21:30

# File Summary

## Purpose:

This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

## File Format:

The content is organized as follows:
1. This summary section
2. Repository information
3. Repository structure
4. Multiple file entries, each consisting of:
   a. A header with the file path (## File: path/to/file)
   b. The full contents of the file in a code block

## Usage Guidelines:

- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

## Notes:

- Some files may have been excluded based on .gitignore rules and Repomix's
  configuration.
- Binary files are not included in this packed representation. Please refer to
  the Repository Structure section for a complete list of file paths, including
  binary files.

## Additional Information:

For more information about Repomix, visit: https://github.com/andersonby/python-repomix


# Repository Structure

```
index.html
js
  api_byo.js
  app.js
  config.js
  diff.js
  ui.js
  util.js
styles.css
```

# Repository Files


## index.html

```html
<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>legacy.exe</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <header>
    <h1>legacy.exe</h1>
    <div class="sub">byo-key client</div>
  </header>

  <main>
    <section class="panel">
      <div class="grid4">
        <div class="row">
          <label>linguagem</label>
          <select id="language">
            <option value="java">java</option>
            <option value="python">python</option>
            <option value="javascript">javascript</option>
            <option value="csharp">csharp</option>
          </select>
        </div>
        <div class="row">
          <label>provider</label>
          <select id="provider">
            <option value="gemini">gemini</option>
            <option value="openai">openai</option>
          </select>
        </div>
        <div class="row">
          <label>model</label>
          <input id="model" placeholder="auto">
        </div>
        <div class="row">
          <label>api key</label>
          <input id="apikey" type="password" placeholder="cole sua chave">
          <button id="remember" class="toggle">remember key</button>
        </div>
      </div>

      <div class="row code-wrap collapsed">
        <label>código legado</label>
        <textarea id="legacy" placeholder="cole aqui" rows="20"></textarea>
        <button id="btn-expand" class="ghost" aria-expanded="false">mostrar mais</button>
      </div>

      <div class="actions below">
        <button id="btn-refactor">refatorar</button>
        <button id="btn-sample">sample</button>
        <div class="muted" id="status"></div>
      </div>
    </section>

    <section class="panel output">
      <div class="columns">
        <div>
          <h3>antes</h3>
          <pre id="before"><code></code></pre>
        </div>
        <div>
          <h3>depois</h3>
          <pre id="after"><code></code></pre>
        </div>
      </div>

      <div class="columns meta">
        <div>
          <h3>diff</h3>
          <pre id="diff"><code></code></pre>
        </div>
        <div>
          <h3>notas</h3>
          <ul id="notes"></ul>
          <h3>summary</h3>
          <ul id="summary"></ul>
          <div class="save">
            <button id="btn-download">baixar código</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="overlay">
    <div class="loader"></div>
    <div class="msg">refatorando...</div>
  </div>

  <script type="module" src="./js/app.js"></script>
</body>
</html>
```

## js/api_byo.js

````javascript
function sysRefactor(lang){
  return `você é um agente de modernização de código. objetivo: reescrever sem alterar comportamento, aplicando padrões modernos. responda em JSON válido { "code": "...", "summary": "...", "notes": "..." }. gere code completo. linguagem alvo: ${lang}`
}
function sysReview(lang){
  return `você é um revisor crítico. dado original e refatorado, devolva JSON { "code": "...", "notes": "..." }. mantenha comportamento, padronize estilo. linguagem: ${lang}`
}
function safeJSON(s){
  try{return JSON.parse(s)}catch{}
  const m=s.match(/```(?:json)?\s*([\s\S]*?)```/i)
  if(m){try{return JSON.parse(m[1])}catch{}}
  return {code:"",summary:"",notes:s||""}
}

async function callOpenAI({apiKey,model,messages}){
  const r = await fetch("https://api.openai.com/v1/chat/completions",{
    method:"POST",
    headers:{authorization:`Bearer ${apiKey}`,"content-type":"application/json"},
    body:JSON.stringify({model:model||"gpt-4o-mini",temperature:0.2,messages})
  })
  const t = await r.text()
  if(!r.ok) throw new Error(t)
  const j = JSON.parse(t)
  return j.choices?.[0]?.message?.content ?? ""
}

function toGemini(messages){
  return messages.map(m=>({role:m.role==="system"?"user":m.role,parts:[{text:String(m.content)}]}))
}

async function callGemini({apiKey,model,messages}){
  const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model||"gemini-1.5-flash"}:generateContent?key=${apiKey}`,{
    method:"POST",
    headers:{"content-type":"application/json"},
    body:JSON.stringify({contents:toGemini(messages),generationConfig:{temperature:0.2}})
  })
  const t = await r.text()
  if(!r.ok) throw new Error(t)
  const j = JSON.parse(t)
  return j.candidates?.[0]?.content?.parts?.map(p=>p.text||"").join("") ?? ""
}

export async function refactorBYO({provider,model,apiKey,code,language}){
  const m1=[
    {role:"system",content:sysRefactor(language)},
    {role:"user",content:`original:\n\`\`\`${language}\n${code}\n\`\`\``}
  ]
  const raw1 = provider==="openai"
    ? await callOpenAI({apiKey,model,messages:m1})
    : await callGemini({apiKey,model,messages:m1})
  const j1 = safeJSON(raw1)

  const m2=[
    {role:"system",content:sysReview(language)},
    {role:"user",content:JSON.stringify({original:code,refactored:j1.code||""})}
  ]
  const raw2 = provider==="openai"
    ? await callOpenAI({apiKey,model,messages:m2})
    : await callGemini({apiKey,model,messages:m2})
  const j2 = safeJSON(raw2)

  return {
    code: j2.code || j1.code || "",
    summary: j1.summary || "",
    notes: j2.notes || ""
  }
}
````

## js/app.js

```javascript
import { refactorBYO } from "./api_byo.js"
import { saveConfig, loadConfig } from "./config.js"
import { el } from "./util.js"
import {
  bindSample, bindRefactor, bindRemember, readInputs, setInputs,
  showBefore, showAfter, showMeta, bindDownload, overlay,
  mountState, showError, status, bindExpand
} from "./ui.js"

const state = mountState()
function setLegacy(v){ el("#legacy").value = v }

const cfg = loadConfig()
setInputs(cfg||{})

bindSample(setLegacy)
bindRemember()
bindExpand()

bindRefactor(async ()=>{
  const input = readInputs()
  if(!input.code.trim()) return
  if(!input.apiKey) { showError("api key ausente"); return }
  if(input.save) saveConfig({provider:input.provider,model:input.model,apiKey:input.apiKey,save:true})

  showBefore(input.code)
  overlay(true); status("rodando...")
  const t0 = performance.now()

  try{
    const r = await refactorBYO({
      provider: input.provider,
      model: input.model,
      apiKey: input.apiKey,
      code: input.code,
      language: input.language
    })
    if(!(r.code && r.code.trim())){
      showError(r.notes || "falha na refatoração")
    }else{
      showAfter(r.code||"")
      state.setAfter(r.code||"")
      showMeta({ before: input.code, after: r.code||"", notes: r.notes||[], summary: r.summary||[] })
    }
  }catch(e){
    showError(String(e))
  }finally{
    const ms = Math.round(performance.now()-t0)
    overlay(false); status(`${input.provider} · ${input.model||"auto"} · ${ms}ms`)
  }
})

bindDownload(()=>state.getAfter())
```

## js/config.js

```javascript
const K="legacyexe.v1"
export function saveConfig({provider,model,apiKey,save}){
  try{ localStorage.setItem(K, JSON.stringify({provider,model,apiKey,save:!!save})) }catch{}
}
export function loadConfig(){
  try{ return JSON.parse(localStorage.getItem(K)||"{}") }catch{ return {} }
}
export function hasSaved(){ try{ return !!(JSON.parse(localStorage.getItem(K)||"{}").apiKey) }catch{ return false } }
```

## js/diff.js

```javascript
function lcsLines(A,B){
  const m=A.length,n=B.length,dp=Array.from({length:m+1},()=>Array(n+1).fill(0))
  for(let i=1;i<=m;i++)for(let j=1;j<=n;j++)
    dp[i][j]=A[i-1]===B[j-1]?dp[i-1][j-1]+1:Math.max(dp[i-1][j],dp[i][j-1])
  const out=[];let i=m,j=n
  while(i>0&&j>0){
    if(A[i-1]===B[j-1]){out.push({t:" ",v:A[i-1]});i--;j--}
    else if(dp[i-1][j]>=dp[i][j-1]){out.push({t:"-",v:A[i-1]});i--}
    else{out.push({t:"+",v:B[j-1]});j--}
  }
  while(i>0){out.push({t:"-",v:A[i-1]});i--}
  while(j>0){out.push({t:"+",v:B[j-1]});j--}
  return out.reverse()
}
export function unifiedDiff(a,b){
  const A=String(a||"").split("\n"),B=String(b||"").split("\n")
  const seq=lcsLines(A,B)
  const lines = ["--- antes","+++ depois",...seq.map(x=>`${x.t} ${x.v}`)]
  return lines.join("\n")
}
```

## js/ui.js

```javascript
import { el, setText, bulletsToList, download } from "./util.js"
import { unifiedDiff } from "./diff.js"

// ---- remember key ----
let remember = false
export function bindRemember(){
  const btn = el("#remember")
  btn.addEventListener("click",()=>{
    remember = !remember
    btn.classList.toggle("active", remember)
    btn.textContent = remember ? "remember key ✓" : "remember key"
  })
}
export function shouldRemember(){ return remember }
export function setRemember(v){
  remember = !!v
  const btn = el("#remember")
  btn.classList.toggle("active", remember)
  btn.textContent = remember ? "remember key ✓" : "remember key"
}

// ---- expand/collapse editor: clamp ~20 linhas e auto-grow sem scrollbar ----
function setClampHeight(container, lines=20){
  const ta = container.querySelector("textarea")
  const cs = getComputedStyle(ta)
  const lh = parseFloat(cs.lineHeight || "18")
  const py = parseFloat(cs.paddingTop||"12")+parseFloat(cs.paddingBottom||"12")
  const max = Math.round(lh*lines + py)
  container.style.setProperty("--ta-max", `${max}px`)
}
function autosize(ta){
  ta.style.height = "auto"
  ta.style.height = ta.scrollHeight + "px"
}
export function bindExpand(){
  const wrap = el(".code-wrap")
  const ta   = el("#legacy")
  const btn  = el("#btn-expand")

  const sync = () => {
    const collapsed = wrap.classList.contains("collapsed")
    btn.textContent = collapsed ? "mostrar mais" : "mostrar menos"
    btn.setAttribute("aria-expanded", String(!collapsed))
    if (collapsed){
      // volta a usar o clamp controlado por CSS
      setClampHeight(wrap, 20)
      ta.style.height = ""
    } else {
      // cresce até caber todo conteúdo
      autosize(ta)
    }
  }

  btn.addEventListener("click", ()=>{
    wrap.classList.toggle("collapsed")
    sync()
  })

  // enquanto digita, só autosize quando expandido
  ta.addEventListener("input", ()=>{ if(!wrap.classList.contains("collapsed")) autosize(ta) })

  window.addEventListener("resize", sync)

  // init
  wrap.classList.add("collapsed")
  setClampHeight(wrap, 20)
  sync()
}

// ---- misc UI helpers ----
export function bindSample(setLegacy){
  el("#btn-sample").addEventListener("click",()=>{ 
    setLegacy(`public class Exemplo {
  public static void main(String[] args){
    System.out.println("Olá mundo");
  }
}`) })
}
export function bindRefactor(onRun){ el("#btn-refactor").addEventListener("click", onRun) }
export function readInputs(){
  return {
    language: el("#language").value,
    provider: el("#provider").value,
    model: el("#model").value.trim() || undefined,
    apiKey: el("#apikey").value.trim(),
    code: el("#legacy").value,
    save: shouldRemember()
  }
}
export function setInputs({provider,model,apiKey,save}){
  if(provider) el("#provider").value = provider
  if(model) el("#model").value = model
  if(apiKey) el("#apikey").value = apiKey
  setRemember(!!save || !!apiKey)
}
export function showBefore(code){ setText(el("#before code"), code||"") }
export function showAfter(code){ setText(el("#after code"), code||"") }
export function showMeta({before, after, notes, summary}){
  setText(el("#diff code"), unifiedDiff(before, after))
  bulletsToList(el("#notes"), notes)
  bulletsToList(el("#summary"), summary)
}
export function showError(msg){
  setText(el("#after code"), "")
  bulletsToList(el("#notes"), [`erro: ${msg}`])
}
export function bindDownload(getAfter){
  el("#btn-download").addEventListener("click",()=>{
    const out = getAfter()
    if(!out) return
    download("legacy_refatorado.txt", out)
  })
}
export function overlay(v){ el("#overlay").style.display = v ? "flex" : "none" }
export function status(t){ el("#status").textContent = t||"" }
export function mountState(){ let after=""; return { setAfter:v=>after=v, getAfter:()=>after } }
```

## js/util.js

```javascript
export function el(q){return document.querySelector(q)}
export function setText(node, text){node.textContent = text}
export function download(filename, text){
  const a = document.createElement("a")
  a.href = URL.createObjectURL(new Blob([text],{type:"text/plain"}))
  a.download = filename
  a.click()
  URL.revokeObjectURL(a.href)
}
export function bulletsToList(node, s){
  node.innerHTML = ""
  if(!s) return
  const arr = Array.isArray(s) ? s : String(s).split(/[\r\n;•-]+/).map(x=>x.trim()).filter(Boolean)
  for(const p of arr.slice(0,12)){
    const li = document.createElement("li")
    li.textContent = p
    node.appendChild(li)
  }
}
```

## styles.css

```css
:root{--bg:#0d0d0f;--fg:#e6e6eb;--muted:#8a8a93;--accent:#ff2a6d;--ok:#24d18a;--card:#141418;--border:#1f1f25}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#0b0b0d,#0e0e12);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
header{padding:24px 20px 8px;display:flex;align-items:flex-end;gap:12px}
h1{margin:0;font-size:28px;letter-spacing:1px;text-transform:lowercase}
.sub{color:var(--muted);font-size:14px}
main{padding:12px 20px 40px;max-width:1200px;margin:0 auto}
.panel{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:16px}
.row{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
.grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
label{font-size:13px;color:var(--muted)}
select,textarea,input{width:100%;background:#0f0f13;color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:12px;font-size:14px;outline:none;transition:border-color .15s, box-shadow .15s}

textarea{
  min-height:260px;
  resize:none;
  overflow:hidden;
  scrollbar-width:none;
  font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Cascadia Code","Fira Code",Consolas,"Liberation Mono",monospace;
  line-height:1.35;
  caret-color:var(--accent);
}
textarea::-webkit-scrollbar{width:0;height:0}

select:focus,textarea:focus,input:focus{border-color:#2b2b34;box-shadow:0 0 0 3px rgba(255,42,109,.12) inset}
.actions{display:flex;gap:8px;align-items:center}
.actions.below{margin-top:12px;justify-content:flex-start}
button{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:12px 16px;font-weight:700;text-transform:lowercase;letter-spacing:.3px;cursor:pointer;transition:filter .2s}
button:hover{filter:brightness(1.1)}
button.toggle{background:#333;font-size:12px;padding:8px 12px;border-radius:8px;text-transform:none}
button.toggle.active{background:var(--accent)}
.muted{color:var(--muted);font-size:12px}

.output .columns{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.output h3{margin:8px 0;font-size:14px;color:var(--muted)}
pre{background:#0f0f13;border:1px solid var(--border);padding:12px;border-radius:10px;overflow:auto;max-height:360px;white-space:pre-wrap}
.meta{margin-top:12px}

#overlay{position:fixed;inset:0;backdrop-filter:blur(4px);background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;flex-direction:column;gap:10px;z-index:10}
.loader{width:28px;height:28px;border-radius:50%;border:3px solid #333;border-top-color:var(--accent);animation:spin 1s linear infinite}
.msg{color:var(--muted);font-size:14px}
.save{margin-top:8px}
@keyframes spin{to{transform:rotate(360deg)}}

@media (max-width:1100px){.grid4{grid-template-columns:1fr 1fr}}
@media (max-width:900px){.output .columns{grid-template-columns:1fr}}

.code-wrap{position:relative}
.code-wrap textarea{width:100%;height:auto}
.code-wrap.collapsed textarea{
  max-height:var(--ta-max,320px);
  mask-image:linear-gradient(to bottom, rgba(0,0,0,1) 65%, rgba(0,0,0,0));
}
.code-wrap .ghost{
  position:absolute;right:12px;bottom:12px;background:#1b1b22;border:1px solid var(--border);color:var(--fg);
  padding:6px 10px;font-size:12px;border-radius:8px;
}
.code-wrap .ghost:hover{opacity:.9}
```

## Statistics

- Total Files: 8
- Total Characters: 15775
- Total Tokens: 0
`````

## styles.css

```css
:root{--bg:#0d0d0f;--fg:#e6e6eb;--muted:#8a8a93;--accent:#ff2a6d;--ok:#24d18a;--card:#141418;--border:#1f1f25}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#0b0b0d,#0e0e12);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
header{padding:24px 20px 8px;display:flex;align-items:flex-end;gap:12px}
h1{margin:0;font-size:28px;letter-spacing:1px;text-transform:lowercase}
.sub{color:var(--muted);font-size:14px}
main{padding:12px 20px 40px;max-width:1200px;margin:0 auto}
.panel{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:16px}
.row{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
.grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
label{font-size:13px;color:var(--muted)}
select,textarea,input{width:100%;background:#0f0f13;color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:12px;font-size:14px;outline:none;transition:border-color .15s, box-shadow .15s}

textarea{
  min-height:260px;
  resize:none;
  overflow:hidden;
  scrollbar-width:none;
  font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Cascadia Code","Fira Code",Consolas,"Liberation Mono",monospace;
  line-height:1.35;
  caret-color:var(--accent);
}
textarea::-webkit-scrollbar{width:0;height:0}

select:focus,textarea:focus,input:focus{border-color:#2b2b34;box-shadow:0 0 0 3px rgba(255,42,109,.12) inset}
.actions{display:flex;gap:8px;align-items:center}
.actions.below{margin-top:12px;justify-content:flex-start}
button{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:12px 16px;font-weight:700;text-transform:lowercase;letter-spacing:.3px;cursor:pointer;transition:filter .2s}
button:hover{filter:brightness(1.1)}
button.toggle{background:#333;font-size:12px;padding:8px 12px;border-radius:8px;text-transform:none}
button.toggle.active{background:var(--accent)}
.muted{color:var(--muted);font-size:12px}

.output .columns{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.output h3{margin:8px 0;font-size:14px;color:var(--muted)}
pre{background:#0f0f13;border:1px solid var(--border);padding:12px;border-radius:10px;overflow:auto;max-height:360px;white-space:pre-wrap}
.meta{margin-top:12px}

#overlay{position:fixed;inset:0;backdrop-filter:blur(4px);background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;flex-direction:column;gap:10px;z-index:10}
.loader{width:28px;height:28px;border-radius:50%;border:3px solid #333;border-top-color:var(--accent);animation:spin 1s linear infinite}
.msg{color:var(--muted);font-size:14px}
.save{margin-top:8px}
@keyframes spin{to{transform:rotate(360deg)}}

@media (max-width:1100px){.grid4{grid-template-columns:1fr 1fr}}
@media (max-width:900px){.output .columns{grid-template-columns:1fr}}

.code-wrap{position:relative}
.code-wrap textarea{width:100%;height:auto}
.code-wrap.collapsed textarea{
  max-height:var(--ta-max,320px);
  mask-image:linear-gradient(to bottom, rgba(0,0,0,1) 65%, rgba(0,0,0,0));
}
.code-wrap .ghost{
  position:absolute;right:12px;bottom:12px;background:#1b1b22;border:1px solid var(--border);color:var(--fg);
  padding:6px 10px;font-size:12px;border-radius:8px;
}
.code-wrap .ghost:hover{opacity:.9}
```

## Statistics

- Total Files: 9
- Total Characters: 34666
- Total Tokens: 0
